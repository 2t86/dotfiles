#!/usr/bin/bash

selection="${NNN_SEL:-${XDG_CONFIG_HOME:-$HOME/.config}/nnn/.selection}"

toggle_file() {
    local file="$1"
    local basename_file=$(basename "$file")

    if getfattr -n user.viewed "$file" 2>/dev/null | grep -q user.viewed; then
        setfattr -x user.viewed "$file" 2>/dev/null
        echo "○ Unmarked: $basename_file"
        return 0
    else
        setfattr -n user.viewed -v "$(date '+%Y-%m-%d %H:%M:%S')" "$file" 2>/dev/null
        echo "✓ Marked: $basename_file"
        return 1
    fi
}

if [[ -s "$selection" ]]; then
    marked=0
    unmarked=0

    while IFS= read -r file; do
        if [[ -f "$file" ]]; then
            if toggle_file "$file"; then
                unmarked=$((unmarked + 1))
            else
                marked=$((marked + 1))
            fi
        fi
    done < "$selection"

    echo ""
    echo "Summary: ${marked} marked, ${unmarked} unmarked"

    : > "$selection"
else
    if [[ -n "$1" && -f "$1" ]]; then
        toggle_file "$1"
    else
        echo "No file selected."
    fi
fi

echo ""
read -r -p "Press Enter to continue..."
